datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

// TABLA 1: GUESTS (Huéspedes)
model Guest {
  id                 String    @id @default(uuid())
  firstName          String    @map("first_name")
  lastName           String    @map("last_name")
  email              String?
  phone              String?
  documentType       String    @map("document_type")
  documentNumber     String    @unique @map("document_number")
  country            String?
  birthDate          DateTime? @map("birth_date")
  notes              String?
  isBlacklisted      Boolean   @default(false) @map("is_blacklisted")
  totalStays         Int       @default(0) @map("total_stays")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  
  reservations       Reservation[]
  currentBed         Bed?

  @@map("guests")
}

// TABLA 2: ROOM TYPES (Tipos de Habitación)
model RoomType {
  id            String    @id @default(uuid())
  name          String    @unique
  bedsCount     Int       @map("beds_count")
  maxOccupancy  Int       @map("max_occupancy")
  basePrice     Decimal   @map("base_price")
  description   String?
  amenities     Json?
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")

  rooms         Room[]

  @@map("room_types")
}

// TABLA 3: ROOMS (Habitaciones físicas)
model Room {
  id            String    @id @default(uuid())
  roomTypeId    String    @map("room_type_id")
  roomNumber    String    @unique @map("room_number")
  floor         Int?      @default(1)
  status        String    @default("active") // active, maintenance, closed
  notes         String?
  createdAt     DateTime  @default(now()) @map("created_at")

  roomType      RoomType  @relation(fields: [roomTypeId], references: [id])
  beds          Bed[]

  @@map("rooms")
}

// TABLA 4: BEDS (Camas individuales)
model Bed {
  id                 String     @id @default(uuid())
  roomId             String     @map("room_id")
  bedNumber          String     @map("bed_number")
  bedType            String     @default("single") @map("bed_type") // single, double, bunk_top, bunk_bottom
  status             String     @default("clean") // clean, dirty, occupied, maintenance, blocked
  currentGuestId     String?    @unique @map("current_guest_id")
  housekeepingNotes  String?    @map("housekeeping_notes")
  lastCleaned        DateTime?  @map("last_cleaned")
  createdAt          DateTime   @default(now()) @map("created_at")

  room               Room       @relation(fields: [roomId], references: [id])
  currentGuest       Guest?     @relation(fields: [currentGuestId], references: [id])
  reservations       Reservation[]

  @@unique([roomId, bedNumber])
  @@map("beds")
}

// TABLA 5: RESERVATIONS (Reservas)
model Reservation {
  id                String     @id @default(uuid())
  confirmationCode  String     @unique @map("confirmation_code")
  primaryGuestId    String     @map("primary_guest_id")
  bedId             String     @map("bed_id")
  checkIn           DateTime   @map("check_in")
  checkOut          DateTime   @map("check_out")
  guestsCount       Int        @default(1) @map("guests_count")
  nightsCount       Int        @map("nights_count")
  baseAmount        Decimal    @map("base_amount")
  taxAmount         Decimal    @default(0.00) @map("tax_amount")
  totalAmount       Decimal    @map("total_amount")
  status            String     @default("confirmed") // confirmed, checked_in, checked_out, cancelled, no_show
  bookingSource     String     @default("direct") @map("booking_source")
  requiresDeposit   Boolean    @default(true) @map("requires_deposit")
  depositAmount     Decimal    @default(0.00) @map("deposit_amount")
  preAuthAmount     Decimal    @default(50.00) @map("pre_auth_amount")
  specialRequests   String?    @map("special_requests")
  arrivalTime       DateTime?  @map("arrival_time")
  bookingDate       DateTime   @default(now()) @map("booking_date")
  checkInTime       DateTime?  @map("check_in_time")
  checkOutTime      DateTime?  @map("check_out_time")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")

  primaryGuest      Guest      @relation(fields: [primaryGuestId], references: [id])
  bed               Bed        @relation(fields: [bedId], references: [id])
  folio             Folio?

  @@index([checkIn, checkOut])
  @@map("reservations")
}

// TABLA 6: FOLIOS (Folios de huéspedes - cuenta de cargos)
model Folio {
  id                String    @id @default(uuid())
  reservationId     String    @unique @map("reservation_id")
  folioNumber       String    @unique @map("folio_number")
  status            String    @default("open") // open, closed, disputed
  totalCharges      Decimal   @default(0.00) @map("total_charges")
  totalPayments     Decimal   @default(0.00) @map("total_payments")
  balance           Decimal   @default(0.00)
  hasPreAuth        Boolean   @default(false) @map("has_pre_auth")
  preAuthReference  String?   @map("pre_auth_reference")
  openedAt          DateTime  @default(now()) @map("opened_at")
  closedAt          DateTime? @map("closed_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  reservation       Reservation @relation(fields: [reservationId], references: [id])
  charges           FolioCharge[]
  payments          Payment[]

  @@index([balance])
  @@map("folios")
}

// TABLA 7: FOLIO CHARGES (Cargos individuales)
model FolioCharge {
  id              String     @id @default(uuid())
  folioId         String     @map("folio_id")
  chargeType      String     @map("charge_type") // room, tax, product, service, penalty
  description     String
  unitPrice       Decimal    @map("unit_price")
  quantity        Int        @default(1)
  totalAmount     Decimal    @map("total_amount")
  productId       String?    @map("product_id")
  chargedByUserId String?    @map("charged_by_user_id")
  isVoided        Boolean    @default(false) @map("is_voided")
  voidReason      String?    @map("void_reason")
  chargeDate      DateTime   @default(now()) @map("charge_date")
  createdAt       DateTime   @default(now()) @map("created_at")

  folio           Folio      @relation(fields: [folioId], references: [id])
  product         Product?   @relation(fields: [productId], references: [id])
  chargedByUser   User?      @relation(fields: [chargedByUserId], references: [id])

  @@map("folio_charges")
}

// TABLA 8: PAYMENTS (Pagos)
model Payment {
  id                 String    @id @default(uuid())
  folioId            String    @map("folio_id")
  paymentMethod      String    @map("payment_method") // cash, card, transfer, digital_wallet
  paymentReference   String?   @map("payment_reference")
  amount             Decimal
  cardLastFour       String?   @map("card_last_four")
  cardType           String?   @map("card_type")
  status             String    @default("completed") // completed, pending, failed, refunded
  processedByUserId  String?   @map("processed_by_user_id")
  notes              String?
  paymentDate        DateTime  @default(now()) @map("payment_date")
  createdAt          DateTime  @default(now()) @map("created_at")

  folio              Folio     @relation(fields: [folioId], references: [id])
  processedByUser    User?     @relation(fields: [processedByUserId], references: [id])

  @@map("payments")
}

// TABLA 9: PRODUCTS (Inventario)
model Product {
  id                      String    @id @default(uuid())
  name                    String    @unique
  category                String?
  costPrice               Decimal   @default(0.00) @map("cost_price")
  salePrice               Decimal   @map("sale_price")
  volunteerPrice          Decimal?  @map("volunteer_price")
  currentStock            Int       @default(0) @map("current_stock")
  minimumStock            Int       @default(0) @map("minimum_stock")
  unit                    String    @default("unit")
  isActive                Boolean   @default(true) @map("is_active")
  requiresAgeVerification Boolean   @default(false) @map("requires_age_verification")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  folioCharges            FolioCharge[]

  @@index([isActive])
  @@map("products")
}

// TABLA 10: USERS (Usuarios del sistema)
model User {
  id            String    @id @default(uuid())
  username      String    @unique
  email         String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  role          String    // admin, reception, volunteer
  permissions   Json?
  isActive      Boolean   @default(true) @map("is_active")
  lastLogin     DateTime? @map("last_login")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  charges         FolioCharge[]
  payments        Payment[]

  @@map("users")
}
